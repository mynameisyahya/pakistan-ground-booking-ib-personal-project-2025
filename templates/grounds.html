{% extends "base.html" %}

{% block title %}Available Grounds - Football Grounds Pakistan{% endblock %}

{% block breadcrumbs %}
<div class="container mt-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Home</a></li>
            <li class="breadcrumb-item active">Available Grounds</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .ground-list-section {
        padding: 40px 0 40px 0;
        width: 100vw;
        min-height: 100vh;
    }
    .modal-content {
        background: var(--dark-bg-400);
        border: 1px solid rgba(29, 185, 84, 0.2);
        color: var(--text-light);
    }
    .modal-header {
        border-bottom: 1px solid rgba(29, 185, 84, 0.2);
    }
    .modal-footer {
        border-top: 1px solid rgba(29, 185, 84, 0.2);
    }
    .modal-title {
        color: var(--text-light);
    }
    .form-label {
        color: var(--text-light);
    }
    .form-control, .form-select {
        background: var(--dark-bg-600);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text-light);
    }
    .form-control:focus, .form-select:focus {
        background: var(--dark-bg-700);
        border-color: var(--primary-green);
        color: var(--text-light);
        box-shadow: 0 0 0 0.2rem rgba(29, 185, 84, 0.25);
    }
    .text-muted {
        color: var(--text-muted) !important;
    }
    .btn-close {
        filter: invert(1);
    }
    .ground-card {
        width: 96vw;
        max-width: 1200px;
        margin: 40px auto;
        border: 2px solid rgba(29, 185, 84, 0.3);
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        background: var(--dark-bg-400);
        display: flex;
        flex-direction: row;
        overflow: hidden;
        min-height: 320px;
        transition: all 0.3s ease;
    }
    .ground-card:hover {
        box-shadow: 0 12px 40px rgba(29, 185, 84, 0.2);
        border-color: rgba(29, 185, 84, 0.6);
        transform: translateY(-2px);
    }
    .ground-map-container {
        width: 50vw;
        max-width: 500px;
        height: 320px;
        flex-shrink: 0;
        position: relative;
        border-radius: 24px 0 0 24px;
        overflow: hidden;
        cursor: pointer;
    }
    .ground-map-container:hover .map-overlay {
        opacity: 1;
    }
    .map-overlay-content {
        background: rgba(29, 185, 84, 0.95);
        color: var(--text-light);
        padding: 12px 20px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    .card-body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 36px 28px;
        width: 100%;
    }
    .ground-title {
        color: var(--text-light);
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .ground-location {
        color: var(--primary-green);
        font-size: 1.1rem;
        margin-bottom: 10px;
        font-weight: 600;
    }
    .ground-address {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 10px;
        font-style: italic;
    }
    .ground-rate {
        color: var(--text-light);
        background: var(--primary-green);
        border-radius: 12px;
        padding: 10px 20px;
        font-size: 1.2rem;
        font-weight: bold;
        display: inline-block;
        margin-top: 18px;
        box-shadow: 0 4px 15px rgba(29, 185, 84, 0.3);
    }
    @media (max-width: 900px) {
        .ground-card {
            flex-direction: column;
            width: 98vw;
            min-height: 0;
            border-radius: 16px;
        }
        .ground-map-container {
            width: 100%;
            height: 180px;
            border-radius: 16px 16px 0 0;
        }
        .card-body {
            padding: 20px 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="ground-list-section">
    <h2 class="mb-4 text-center" style="color:var(--yale-blue);font-weight:bold;">Available Grounds</h2>
    <div id="grounds-list">
        {# Check if there are any grounds to display #}
        {% if grounds %}
            {# Loop through each ground in the grounds list #}
            {% for ground in grounds %}
                <div class="card ground-card">
                    {# Display OpenStreetMap instead of static image #}
                    <div class="ground-map-container">
                        <div class="ground-map" id="map-{{ ground.id }}"></div>
                        <div class="map-overlay" onclick="openOpenStreetMap({{ ground.latitude }}, {{ ground.longitude }}, '{{ ground.name }}')">
                            <div class="map-overlay-content">
                                üó∫Ô∏è Click to open in OpenStreetMap
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        {# Display the ground's name #}
                        <div class="ground-title">{{ ground.name }}</div>
                        {# Display the ground's city #}
                        <div class="ground-location">{{ ground.city or ground.location }}</div>
                        {# Display the ground's full address if available #}
                        {% if ground.full_address %}
                        <div class="ground-address">{{ ground.full_address }}</div>
                        {% endif %}
                        {# Display the ground's rate per hour #}
                        <div class="ground-rate">Rs {{ ground.rate }}/hour</div>
                        {# Button to view and book the ground #}
                        <a href="{{ url_for('final_booking', ground_id=ground.id) }}" class="btn btn-success mt-4 w-100">View & Book</a>
                        {% if is_player %}
                        <button class="btn btn-primary mt-2 w-100" data-bs-toggle="modal" data-bs-target="#joinMatchModal{{ ground.id }}">Join Match</button>
                        <button class="btn btn-outline-info mt-2 w-100" data-bs-toggle="modal" data-bs-target="#viewTeammatesModal{{ ground.id }}">View Teammates</button>
                        {% endif %}
                    </div>
                </div>
                {% if is_player %}
                <!-- Join Match Modal for this ground -->
                <div class="modal fade" id="joinMatchModal{{ ground.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Join Match - {{ ground.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                       <form method="POST" action="{{ url_for('join_match', ground_id=ground.id) }}">
                        <div class="modal-body">
                          <div class="mb-3">
                            <label for="date{{ ground.id }}" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date{{ ground.id }}" name="date" required>
                          </div>
                          <div class="mb-3">
                            <label for="time{{ ground.id }}" class="form-label">Time</label>
                            <select class="form-control" id="time{{ ground.id }}" name="time" required></select>
                          </div>
                          <div class="text-muted small">You'll be added to the waiting pool for this ground, date and time. Once 10 players join, teams are formed using median-based balancing and sent to the host.</div>
                           <div class="mt-3">
                             <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#viewTeammatesModal{{ ground.id }}">View Teammates</button>
                           </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-primary">Join Match</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                <!-- View Teammates Modal (on-demand fetch) -->
                <div class="modal fade" id="viewTeammatesModal{{ ground.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered modal-fullscreen-sm-down">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Teammates - {{ ground.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <div class="row g-2 mb-3">
                          <div class="col-6">
                            <label class="form-label small">Date</label>
                            <input type="date" class="form-control" id="vt-date{{ ground.id }}">
                          </div>
                          <div class="col-6">
                            <label class="form-label small">Time</label>
                            <select class="form-control" id="vt-time{{ ground.id }}"></select>
                          </div>
                        </div>
                        <div class="d-flex justify-content-end mb-2">
                          <button type="button" class="btn btn-sm btn-outline-secondary" id="teammates-refresh-{{ ground.id }}">Refresh</button>
                        </div>
                        <div id="teammates-visualizer-{{ ground.id }}" class="tv-container"></div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            {# Show a message if there are no grounds available #}
            <div class="text-center text-muted">No grounds available at the moment.</div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- OpenStreetMap with Leaflet (No API key required) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
        // Initialize OpenStreetMap for each ground
        document.addEventListener('DOMContentLoaded', function() {
            const grounds = {{ grounds_json|tojson }};
            
            grounds.forEach(function(ground) {
                if (ground.latitude && ground.longitude) {
                    initializeGroundMap(ground);
                }
            });
            // Populate all time dropdowns for join match and teammates modals
            populateAllTimeDropdowns();
        });

        function populateAllTimeDropdowns() {
          // For join match modals
          document.querySelectorAll('select[id^="time"]').forEach(function(select) {
            if (select.id.startsWith('time') && !select.id.startsWith('vt-time')) {
              populateTimeDropdown(select);
            }
          });
          // For teammates modals
          document.querySelectorAll('select[id^="vt-time"]').forEach(populateTimeDropdown);
        }
        function populateTimeDropdown(select) {
          select.innerHTML = '<option value="">Select Time</option>';
          for (let hour = 6; hour <= 22; hour += 2) {
            const timeStr = hour.toString().padStart(2, '0') + ':00';
            const timeLabel = hour < 12 ? hour + ':00 AM' : (hour === 12 ? '12:00 PM' : (hour-12) + ':00 PM');
            const option = document.createElement('option');
            option.value = timeStr;
            option.textContent = timeLabel;
            select.appendChild(option);
          }
        }

function initializeGroundMap(ground) {
    const mapElement = document.getElementById(`map-${ground.id}`);
    if (!mapElement) return;
    
    // Create map centered on ground location
    const map = L.map(mapElement).setView([parseFloat(ground.latitude), parseFloat(ground.longitude)], 15);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Add marker for the ground
    const marker = L.marker([parseFloat(ground.latitude), parseFloat(ground.longitude)]).addTo(map);
    
    // Add popup with ground info
    const popupContent = `
        <div style="padding: 10px; max-width: 200px;">
            <h6 style="margin: 0 0 5px 0; color: #0d3b66;">${ground.name}</h6>
            <p style="margin: 0; font-size: 12px; color: #666;">
                ${ground.city || ground.location}<br>
                Rs ${ground.rate}/hour
            </p>
        </div>
    `;
    
    marker.bindPopup(popupContent);
}

// Function to open OpenStreetMap in new tab
function openOpenStreetMap(lat, lng, groundName) {
    const url = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}&zoom=16&layers=M`;
    window.open(url, '_blank');
}
</script>

<script>
  (function(){
    // Simple animated visualizer (no framework). Polls every 3s.
    function h(tag, className, children){
      var el = document.createElement(tag);
      if(className) el.className = className;
      (children||[]).forEach(function(c){ if(typeof c === 'string'){ el.appendChild(document.createTextNode(c)); } else if(c){ el.appendChild(c); } });
      return el;
    }
    function style(){
      var css = `
      .tv-container{padding:10px;background:var(--dark-bg-500);border-radius:12px;border:1px solid rgba(29,185,84,.2);color:var(--text-light)}
      .tv-count{font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:10px;color:var(--text-light)}
      .tv-progress{height:12px;background:var(--dark-bg-700);border-radius:999px;overflow:hidden;box-shadow:inset 0 0 0 1px rgba(29,185,84,.2)}
      .tv-progress > div{height:100%;background:var(--primary-green);width:0;transition:width .6s cubic-bezier(.2,.8,.2,1)}
      .tv-progress.fixed > div{transition:none !important}
      .tv-progress.full > div{background:var(--primary-green)}
      .tv-lobby-wrap{padding:10px;border:1px solid rgba(29,185,84,.2);border-radius:12px;background:rgba(29,185,84,.05);margin-top:12px}
      .tv-lobby{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
      @media(min-width:992px){.tv-lobby{grid-template-columns:repeat(10,1fr)}}
      .tv-slot{height:60px;border-radius:12px;border:1px dashed rgba(29,185,84,.3);display:flex;align-items:center;justify-content:center;background:rgba(29,185,84,.05);font-size:0.8rem;color:var(--text-muted)}
      .tv-grid-wrap{margin-top:14px;padding:10px;border:1px solid rgba(29,185,84,.2);border-radius:12px;background:rgba(29,185,84,.05)}
      .tv-grid{display:grid;grid-template-columns:1fr 1px 1fr;gap:12px;align-items:start}
      .tv-divider{width:1px;background:linear-gradient(180deg,rgba(29,185,84,.4),rgba(29,185,84,.1));height:100%;min-height:120px;border-radius:999px}
      .tv-col{display:grid;grid-template-columns:1fr 1fr;gap:8px}
      @media(min-width:768px){.tv-col{grid-template-columns:1fr 1fr}}
      .tv-card{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid rgba(29,185,84,.2);border-radius:12px;background:var(--dark-bg-600);backdrop-filter:blur(6px);opacity:0;transform:translateY(10px) scale(.98);transition:opacity .35s ease, transform .35s ease, box-shadow .2s ease}
      .tv-card.show{opacity:1;transform:translateY(0) scale(1);box-shadow:0 4px 16px rgba(29,185,84,.2)}
      .tv-card.leaving-left{animation:tv-leave-left .35s ease forwards}
      .tv-card.leaving-right{animation:tv-leave-right .35s ease forwards}
      @keyframes tv-leave-left{to{transform:translate(-60px,120px) scale(.95);opacity:0.2}}
      @keyframes tv-leave-right{to{transform:translate(60px,120px) scale(.95);opacity:0.2}}
      .tv-ghost{position:relative}
      .tv-slide-left{animation:tv-slide-left .55s ease forwards}
      .tv-slide-right{animation:tv-slide-right .55s ease forwards}
      @keyframes tv-slide-left{from{transform:translateY(-18px);opacity:0}to{transform:translateY(0);opacity:1}}
      @keyframes tv-slide-right{from{transform:translateY(-18px);opacity:0}to{transform:translateY(0);opacity:1}}
      .tv-card-slot{display:flex;align-items:center;justify-content:center;min-height:64px;border-radius:12px;border:1px solid rgba(29,185,84,.2);background:rgba(29,185,84,.08);}
      .tv-ball{width:40px;height:40px;border-radius:50%;background:var(--dark-bg-700) url('https://em-content.zobj.net/thumbs/240/apple/354/soccer-ball_26bd.png') center/cover no-repeat;box-shadow:0 4px 14px rgba(0,0,0,.5);transform:scale(.2);opacity:.2;animation:tv-ball-pop .5s ease-out forwards}
      @keyframes tv-ball-pop{0%{transform:scale(.2);opacity:.2}70%{transform:scale(1.15);opacity:1}100%{transform:scale(1);opacity:1}}
      .tv-ball.out{animation:tv-ball-out .28s ease-in forwards}
      @keyframes tv-ball-out{0%{transform:scale(1);opacity:1}100%{transform:scale(.1);opacity:0}}
      .tv-img{width:40px;height:44px;border-radius:50%;object-fit:cover;box-shadow:0 2px 8px rgba(0,0,0,.4)}
      .tv-name{font-weight:700;color:var(--text-light);font-size:0.85rem}
      .tv-age{font-size:.75rem;color:var(--text-muted)}
      .tv-skeleton{height:60px;border-radius:12px;background:linear-gradient(90deg,rgba(29,185,84,.08),rgba(29,185,84,.15),rgba(29,185,84,.08));background-size:200% 100%;animation:tv-shimmer 1.2s infinite}
      @keyframes tv-shimmer{0%{background-position:0% 0}100%{background-position:-200% 0}}
      .tv-badge{margin-left:auto;font-size:.7rem;padding:.15rem .4rem;border-radius:999px;background:var(--primary-green);color:var(--text-light);border:1px solid rgba(29,185,84,.3)}
      .tv-team-title{font-weight:800;letter-spacing:.02em;margin-bottom:8px;color:var(--primary-green)}
      .tv-flyer{position:fixed; z-index:1085; pointer-events:none;}
      `;
      var s=document.createElement('style'); s.innerHTML=css; document.head.appendChild(s);
    }
    style();
    var stateByGround = {};
    var FALLBACK_PFPS = [
      'https://em-content.zobj.net/thumbs/240/apple/354/clown-face_1f921.png',
      'https://em-content.zobj.net/thumbs/240/apple/354/skull_1f480.png',
      'https://em-content.zobj.net/thumbs/240/apple/354/goblin_1f47a.png',
      'https://em-content.zobj.net/thumbs/240/apple/354/ogre_1f479.png',
      'https://em-content.zobj.net/thumbs/240/apple/354/pile-of-poo_1f4a9.png',
      'https://em-content.zobj.net/thumbs/240/apple/354/zany-face_1f92a.png',
      'https://em-content.zobj.net/thumbs/240/apple/354/hot-face_1f975.png',
      'https://em-content.zobj.net/thumbs/240/apple/354/loudly-crying-face_1f62d.png',
      'https://em-content.zobj.net/thumbs/240/apple/354/fire_1f525.png',
      'https://em-content.zobj.net/thumbs/240/apple/354/alien_1f47d.png',
      'https://em-content.zobj.net/thumbs/240/apple/354/nauseated-face_1f922.png',
      'https://em-content.zobj.net/thumbs/240/apple/354/smiling-face-with-sunglasses_1f60e.png'
    ];
    function hashStr(s){ if(!s) return 0; var h=0; for(var i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return Math.abs(h); }
    function getAvatarUrl(st, player){
      st.avatarByEmail = st.avatarByEmail || {};
      var key = (player && player.email) || (player && player.name) || 'anon';
      if(st.avatarByEmail[key]) return st.avatarByEmail[key];
      var url = player && player.profile_image_url ? player.profile_image_url : FALLBACK_PFPS[hashStr(key) % FALLBACK_PFPS.length];
      st.avatarByEmail[key] = url;
      return url;
    }
    function avatarImg(st, player){
      var img = h('img','tv-img');
      img.src = getAvatarUrl(st, player);
      img.onerror = function(){
        var key = (player && player.email) || (player && player.name) || 'anon';
        var url = FALLBACK_PFPS[hashStr(key+'fallback') % FALLBACK_PFPS.length];
        if(img.src !== url){ img.src = url; st.avatarByEmail[key] = url; }
      };
      return img;
    }

    function render(container, data, groundId){
      var prevState = stateByGround[groundId];
      if(prevState && prevState.animating){
        return; // avoid overlapping animations while a transition is in progress
      }
      // If already in teams phase and nothing changed, keep the current DOM (avoid re-creating bar and re-running animations)
      if(prevState && prevState.phase === 'teams' && prevState.transitioned && data && data.status !== 'waiting'){
        return;
      }
      container.innerHTML='';
      var capacity=(data.capacity||10);
      var countWrap=h('div','tv-count',[data.count + ' / ' + capacity + ' players joined']);
      var barOuter=h('div','tv-progress'), bar=h('div'); barOuter.appendChild(bar);
      if(data.count >= capacity){ barOuter.classList.add('full'); barOuter.classList.add('fixed'); }
      container.appendChild(countWrap); container.appendChild(barOuter);
      requestAnimationFrame(function(){ bar.style.width=((data.count/capacity)*100)+'%'; });

      var players=(data.players||[]);
      var allAssigned = players.length===capacity && players.every(function(p){ return p.team==='A' || p.team==='B'; });
      var state = stateByGround[groundId] || { phase: 'lobby', transitioned: false, matchId: data.match_id, animating: false, avatarByEmail:{} };
      if(state.matchId !== data.match_id){ state = { phase: 'lobby', transitioned: false, matchId: data.match_id, animating: false, avatarByEmail:{} }; }

      if(!allAssigned){ state.phase = 'lobby'; }

      if(state.phase === 'lobby' || state.phase === 'transitioning'){
        // Build top lobby container with header and 10 slots, shuffled cards
        var lobbyWrap=h('div','tv-lobby-wrap');
        var lobbyTitle=h('div','tv-team-title',["Lobby (unsorted)"]);
        var lobby=h('div','tv-lobby');
        var shuffled=players.slice().sort(function(){ return Math.random()-0.5; });
        for(var i=0;i<capacity;i++){
          if(i<shuffled.length){
            var p=shuffled[i];
            var card=h('div','tv-card');
            var img=avatarImg(state, p);
            var meta=h('div','', [ h('div','tv-name',[p.name || p.email || 'Player']), h('div','tv-age',['Age: ' + (p.age ?? '-')]) ]);
            card.appendChild(img); card.appendChild(meta);
            (function(card,delay){ setTimeout(function(){ card.classList.add('show'); }, delay); })(card, 25*i);
            lobby.appendChild(card);
          } else {
            lobby.appendChild(h('div','tv-slot',["Empty"]));
          }
        }
        lobbyWrap.appendChild(lobbyTitle);
        lobbyWrap.appendChild(lobby);
        container.appendChild(lobbyWrap);

        // If we just became full and assignment exists, schedule transition
        if(allAssigned && !state.transitioned && !state.animating){
          state.phase = 'transitioning';
          state.animating = true;
          stateByGround[groundId] = state;
          var snapshot = JSON.parse(JSON.stringify(players));
          setTimeout(function(){ transitionFromLobby(container, lobbyWrap, lobby, snapshot, capacity, groundId); }, 1000);
          return;
        }
      }

      if(state.phase === 'teams' && allAssigned){
        renderTeams(container, players, capacity, false, groundId);
      }

      stateByGround[groundId] = state;
    }

    function renderTeams(container, players, capacity, animate, groundId){
      var gridWrap=h('div','tv-grid-wrap');
      var grid=h('div','tv-grid');
      var colA=h('div','tv-col');
      var colB=h('div','tv-col');
      var divider=h('div','tv-divider');
      colA.appendChild(h('div','tv-team-title',['Team A']));
      colB.appendChild(h('div','tv-team-title',['Team B']));
      var aCount=0,bCount=0;
      players.forEach(function(p, idx){
        var target = p.team === 'B' ? colB : colA;
        if(animate){
          var slot=h('div','tv-card-slot');
          var ball=h('div','tv-ball');
          slot.appendChild(ball);
          target.appendChild(slot);
          // Reveal player card after ball pop-in
          (function(slot,ball,player,delay,i){
            setTimeout(function(){
              ball.classList.add('out');
              setTimeout(function(){
                var card=h('div','tv-card');
                var img=avatarImg(stateByGround[groundId], player);
                var meta=h('div','', [ h('div','tv-name',[player.name || player.email || 'Player']), h('div','tv-age',['Age: ' + (player.age ?? '-')]) ]);
                card.appendChild(img); card.appendChild(meta);
                if(player.team){ card.appendChild(h('span','tv-badge',['Team '+player.team])); }
                slot.replaceWith(card);
                requestAnimationFrame(function(){ card.classList.add('show'); });
              }, 200);
            }, delay);
          })(slot, ball, p, 160*idx, idx);
        } else {
          var card=h('div','tv-card show');
          var img=avatarImg(stateByGround[groundId], p);
          var meta=h('div','', [ h('div','tv-name',[p.name || p.email || 'Player']), h('div','tv-age',['Age: ' + (p.age ?? '-')]) ]);
          card.appendChild(img); card.appendChild(meta);
          if(p.team){ card.appendChild(h('span','tv-badge',['Team '+p.team])); }
          target.appendChild(card);
        }
        if(target===colA) aCount++; else bCount++;
      });
      for(var i=aCount;i<5;i++){ colA.appendChild(h('div','tv-skeleton')); }
      for(var j=bCount;j<5;j++){ colB.appendChild(h('div','tv-skeleton')); }
      grid.appendChild(colA); grid.appendChild(divider); grid.appendChild(colB);
      gridWrap.appendChild(grid);
      container.appendChild(gridWrap);
    }

    function transitionFromLobby(container, lobbyWrap, lobby, players, capacity, groundId){
      // Create team grid under lobby and keep lobby visible above
      var gridWrap=h('div','tv-grid-wrap');
      var grid=h('div','tv-grid');
      var colA=h('div','tv-col');
      var colB=h('div','tv-col');
      var divider=h('div','tv-divider');
      colA.appendChild(h('div','tv-team-title',['Team A']));
      colB.appendChild(h('div','tv-team-title',['Team B']));
      container.appendChild(gridWrap);
      gridWrap.appendChild(grid);
      grid.appendChild(colA); grid.appendChild(divider); grid.appendChild(colB);

      var lobbyCards = Array.prototype.slice.call(lobby.querySelectorAll('.tv-card'));
      // Map lobby cards by player email (or name as fallback)
      var playerToCard = {};
      lobbyCards.forEach(function(card, idx){
        var name = card.querySelector('.tv-name')?.textContent;
        var email = (players[idx] && players[idx].email) || name;
        if(email) playerToCard[email] = card;
      });
      // Animate translationally: clone moving card and fly to target position one-by-one
      function getCenter(el){ var r=el.getBoundingClientRect(); return { x:r.left + r.width/2 + window.scrollX, y:r.top + r.height/2 + window.scrollY }; }
      function createFlyer(card){
        var r=card.getBoundingClientRect();
        var clone=card.cloneNode(true); clone.classList.add('tv-flyer'); clone.style.left=r.left+window.scrollX+'px'; clone.style.top=r.top+window.scrollY+'px'; clone.style.width=r.width+'px'; clone.style.opacity='1'; document.body.appendChild(clone); return clone;
      }
      function ensureTeamSlot(targetCol){ var slot=h('div','tv-card-slot'); targetCol.appendChild(slot); return slot; }
      function moveOne(i){
        if(i>=players.length){ finish(); return; }
        var p=players[i];
        var source = playerToCard[p.email] || lobbyCards[i];
        if(!source){ moveOne(i+1); return; }
        // faint ghost remains
        source.style.opacity=0.2; source.style.transform='scale(.98)';
        var flyer=createFlyer(source);
        var targetCol = p.team==='B' ? colB : colA;
        var slot=ensureTeamSlot(targetCol);
        var targetCenter=getCenter(slot);
        var flyerCenter=getCenter(flyer);
        var dx=targetCenter.x - flyerCenter.x; var dy=targetCenter.y - flyerCenter.y;
        flyer.style.transition='transform .85s ease, opacity .85s ease';
        flyer.style.transform='translate('+dx+'px,'+dy+'px)';
        setTimeout(function(){
          // replace slot with final card (avoid double boxes)
          var cardEl=h('div','tv-card show');
          var img=avatarImg(stateByGround[groundId], p);
          var meta=h('div','', [ h('div','tv-name',[p.name || p.email || 'Player']), h('div','tv-age',['Age: ' + (p.age ?? '-')]) ]);
          cardEl.appendChild(img); cardEl.appendChild(meta);
          if(p.team){ cardEl.appendChild(h('span','tv-badge',['Team '+p.team])); }
          slot.replaceWith(cardEl);
          flyer.style.opacity='0';
          setTimeout(function(){ flyer.remove(); moveOne(i+1); }, 125);
        }, 480);
      }
      function finish(){
        var st = stateByGround[groundId] || {};
        st.phase='teams'; st.transitioned=true; st.animating=false; stateByGround[groundId]=st;
        if(lobbyWrap){
          lobbyWrap.style.overflow='hidden';
          lobbyWrap.style.maxHeight = lobbyWrap.scrollHeight + 'px';
          lobbyWrap.style.transition = 'opacity .35s ease, max-height .45s ease, margin .3s ease, padding .3s ease';
          requestAnimationFrame(function(){ lobbyWrap.style.opacity='0'; lobbyWrap.style.maxHeight='0'; lobbyWrap.style.margin='0'; lobbyWrap.style.padding='0'; });
          setTimeout(function(){ if(lobbyWrap && lobbyWrap.parentNode){ lobbyWrap.parentNode.removeChild(lobbyWrap); } }, 520);
        }
      }
      // Start sequential movement
      setTimeout(function(){ moveOne(0); }, 100);
    }
    function getDateTime(groundId){
      var dateEl=document.getElementById('vt-date'+groundId) || document.getElementById('date'+groundId);
      var timeEl=document.getElementById('vt-time'+groundId) || document.getElementById('time'+groundId);
      var dateVal = dateEl && dateEl.value ? dateEl.value : new Date().toISOString().slice(0,10);
      var timeVal = timeEl && timeEl.value ? timeEl.value : (function(){ var d=new Date(); var hh=String(d.getHours()).padStart(2,'0'); var mm=String(d.getMinutes()).padStart(2,'0'); return hh+':'+mm; })();
      // backfill inputs for UX
      if(dateEl && !dateEl.value) dateEl.value = dateVal;
      if(timeEl && !timeEl.value) timeEl.value = timeVal;
      return { date: dateVal, time: timeVal };
    }
    function poll(container, groundId){
      var dt=getDateTime(groundId); if(!dt.date || !dt.time) return;
      fetch('/api/match_pool/'+groundId+'?date='+encodeURIComponent(dt.date)+'&time='+encodeURIComponent(dt.time))
       .then(function(r){return r.json();})
       .then(function(data){ if(data && !data.error){ render(container, data);} })
       .catch(function(){});
    }
    // DEMO DATA for default view (full team, all assigned)
    var demoData = {
      "match_id": "demo_123",
      "status": "teams",
      "capacity": 10,
      "count": 10,
      "players": [
        {"email": "demo1@example.com", "name": "Ahmed Khan", "age": 25, "profile_image_url": "https://em-content.zobj.net/thumbs/240/apple/354/soccer-ball_26bd.png", "team": "A"},
        {"email": "demo2@example.com", "name": "Sara Ahmed", "age": 28, "profile_image_url": "https://em-content.zobj.net/thumbs/240/apple/354/soccer-ball_26bd.png", "team": "B"},
        {"email": "demo3@example.com", "name": "Usman Ali", "age": 22, "profile_image_url": "https://em-content.zobj.net/thumbs/240/apple/354/soccer-ball_26bd.png", "team": "A"},
        {"email": "demo4@example.com", "name": "Fatima Zahra", "age": 26, "profile_image_url": "https://em-content.zobj.net/thumbs/240/apple/354/soccer-ball_26bd.png", "team": "B"},
        {"email": "demo5@example.com", "name": "Hassan Raza", "age": 24, "profile_image_url": "https://em-content.zobj.net/thumbs/240/apple/354/soccer-ball_26bd.png", "team": "A"},
        {"email": "demo6@example.com", "name": "Ayesha Malik", "age": 29, "profile_image_url": "https://em-content.zobj.net/thumbs/240/apple/354/soccer-ball_26bd.png", "team": "B"},
        {"email": "demo7@example.com", "name": "Bilal Hassan", "age": 23, "profile_image_url": "https://em-content.zobj.net/thumbs/240/apple/354/soccer-ball_26bd.png", "team": "A"},
        {"email": "demo8@example.com", "name": "Zainab Noor", "age": 27, "profile_image_url": "https://em-content.zobj.net/thumbs/240/apple/354/soccer-ball_26bd.png", "team": "B"},
        {"email": "demo9@example.com", "name": "Ali Raza", "age": 21, "profile_image_url": "https://em-content.zobj.net/thumbs/240/apple/354/soccer-ball_26bd.png", "team": "A"},
        {"email": "demo10@example.com", "name": "Mehwish Tariq", "age": 30, "profile_image_url": "https://em-content.zobj.net/thumbs/240/apple/354/soccer-ball_26bd.png", "team": "B"}
      ]
    };

    // On teammates modal open, show demo team for default date/time, otherwise fetch from backend
    document.addEventListener('shown.bs.modal', function (event) {
      var modal=event.target; if(!modal.id || modal.id.indexOf('viewTeammatesModal')!==0) return;
      var groundId=modal.id.replace('viewTeammatesModal','');
      var mount=document.getElementById('teammates-visualizer-'+groundId);
      if(!mount) return;
      // Set default date/time to today and first time slot
      var dateSel = document.getElementById('vt-date'+groundId);
      var timeSel = document.getElementById('vt-time'+groundId);
      if(dateSel) dateSel.value = new Date().toISOString().slice(0,10);
      if(timeSel && timeSel.options.length>1) timeSel.selectedIndex=1;
      // Show demo team for default
      render(mount, demoData, groundId);
      // On change, fetch from backend
      var onChange = function() {
        var dt = getDateTime(groundId);
        // If default, show demo
        if ((dateSel && dateSel.value === new Date().toISOString().slice(0,10)) && (timeSel && timeSel.selectedIndex === 1)) {
          render(mount, demoData, groundId);
        } else {
          fetch('/api/match_pool/'+groundId+'?date='+encodeURIComponent(dt.date)+'&time='+encodeURIComponent(dt.time))
            .then(function(r){return r.json();})
            .then(function(data){
              if(data && !data.error && data.count > 0){
                render(mount, data, groundId);
              } else {
                mount.innerHTML = '<div class="text-center text-muted py-4"><h5>No Games Scheduled</h5><p>There are no games scheduled for this date and time.</p></div>';
              }
            })
            .catch(function(){
              mount.innerHTML = '<div class="text-center text-danger py-4"><h5>Error Loading Data</h5><p>Could not load match information. Please try again.</p></div>';
            });
        }
      };
      dateSel && dateSel.addEventListener('change', onChange);
      timeSel && timeSel.addEventListener('change', onChange);
    });
  })();
</script>
{% endblock %}